<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Transaction Pipeline - Architecture Diagram</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1565c0;
            border-bottom: 3px solid #1565c0;
            padding-bottom: 10px;
        }
        h2 {
            color: #424242;
            margin-top: 30px;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #fafafa;
            border-radius: 6px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid;
        }
        .diagram {
            margin-top: 30px;
            overflow-x: auto;
        }
        .mermaid {
            text-align: center;
        }
        .note {
            background: #e3f2fd;
            border-left: 4px solid #1565c0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bank Transaction Pipeline Architecture</h1>

        <div class="note">
            <strong>Note:</strong> This diagram represents the ETL pipeline for processing bank transaction data.
            The pipeline extracts raw CSV data, validates and transforms it, performs reconciliation checks,
            and outputs ledger and aggregation files.
        </div>

        <h2>Component Legend</h2>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #fff8e1; border-color: #f57f17;"></div>
                <span>Data Sources</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e3f2fd; border-color: #1565c0;"></div>
                <span>Processing Components</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f3e5f5; border-color: #7b1fa2;"></div>
                <span>Validation & Quality</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e8f5e9; border-color: #2e7d32;"></div>
                <span>Outputs</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fce4ec; border-color: #c2185b;"></div>
                <span>Configuration</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff3e0; border-color: #ef6c00;"></div>
                <span>Checkpoint/Resume</span>
            </div>
        </div>

        <h2>Pipeline Flow Diagram</h2>
        <div class="diagram">
            <pre class="mermaid">
flowchart TB
    subgraph Sources["üìÅ Data Sources"]
        RAW_CSV["transactions_raw.csv\nRaw transaction feed"]
        BAD_CSV["bad_transactions.csv\nTest data with errors"]
    end

    subgraph Config["‚öôÔ∏è Configuration Layer"]
        YAML["pipeline_config.yaml"]
        SCHEMA["config_schema.py\nPydantic validation"]
        CFG_LOADER["config.py\nConfig loader"]
    end

    subgraph ExtractLayer["üîç Extract Layer src/extract.py"]
        EXTRACT["extract_transactions()"]
        SCHEMA_VAL["Schema Validation\n- Required columns\n- No duplicate txn_id\n- No nulls"]
        CHUNK["Chunked Processing\n(Optional)"]
    end

    subgraph TransformLayer["üîß Transform Layer src/transform.py"]
        TRANSFORM["transform_transactions()"]
        PARSE["Parse Dates\n(txn_date, ingestion_date)"]
        NORMALIZE["Normalize Status\n‚Üí SUCCESS/FAILED"]
        AMOUNT["Normalize Amount\n(Refunds = negative)"]
        LATE["Detect Late Arrivals\n(txn_date < ingestion_date)"]
    end

    subgraph QualityLayer["üìä Quality Layer src/quality.py"]
        QUALITY["calculate_quality_metrics()"]
        METRICS["data_quality_metrics.json"]
        REJECT["rejection_report.csv"]
    end

    subgraph ReconcileLayer["‚öñÔ∏è Reconcile Layer src/reconcile.py"]
        RECONCILE["reconcile_raw_vs_ledger()"]
        TOLERANCE["Tolerance Check\n(default: 0.00)"]
    end

    subgraph LoadLayer["üíæ Load Layer src/load.py"]
        LOAD["load_ledger()"]
        VALIDATE["Validate txn_id\n(Unique, No nulls)"]
        PARQUET["ledger_transactions.parquet"]
    end

    subgraph AggregateLayer["üìà Aggregation Layer"]
        AGG["Daily Balance\nAggregation"]
        DAILY["daily_account_balance.parquet"]
    end

    subgraph CheckpointLayer["üîÑ Fault Tolerance src/checkpoint.py"]
        CHECKPOINT["PipelineCheckpoint"]
        CKPT_DIR["data/checkpoints/"]
    end

    subgraph Orchestrator["üéõÔ∏è Orchestrator src/pipeline.py"]
        PIPELINE["run_pipeline()"]
    end

    %% Data Flow
    RAW_CSV --> PIPELINE
    YAML --> CFG_LOADER --> PIPELINE
    SCHEMA -.-> CFG_LOADER

    PIPELINE --> EXTRACT
    EXTRACT --> SCHEMA_VAL
    SCHEMA_VAL --> TRANSFORM

    TRANSFORM --> PARSE --> NORMALIZE --> AMOUNT --> LATE

    LATE --> QUALITY
    QUALITY --> METRICS
    QUALITY --> REJECT

    LATE --> RECONCILE
    RECONCILE --> TOLERANCE --> LOAD
    LOAD --> VALIDATE --> PARQUET --> AGG --> DAILY

    %% Checkpoints
    PIPELINE -.-> CHECKPOINT
    EXTRACT -.-> CHECKPOINT
    TRANSFORM -.-> CHECKPOINT
    RECONCILE -.-> CHECKPOINT
    LOAD -.-> CHECKPOINT
            </pre>
        </div>

        <h2>Pipeline Stages</h2>
        <ol>
            <li><strong>Extract</strong> (<code>src/extract.py</code>): Load and validate raw CSV data with schema validation</li>
            <li><strong>Transform</strong> (<code>src/transform.py</code>): Clean, normalize, and enrich transaction data</li>
            <li><strong>Quality Check</strong> (<code>src/quality.py</code>): Calculate metrics and generate rejection reports</li>
            <li><strong>Reconcile</strong> (<code>src/reconcile.py</code>): Validate totals match between raw and ledger data</li>
            <li><strong>Load</strong> (<code>src/load.py</code>): Persist validated data to Parquet format</li>
            <li><strong>Aggregate</strong> (<code>src/pipeline.py</code>): Generate daily account balance summaries</li>
        </ol>

        <h2>Key Features</h2>
        <ul>
            <li><strong>Configuration-driven:</strong> All business rules configurable via YAML</li>
            <li><strong>Fail-fast validation:</strong> Strict data quality checks prevent bad data</li>
            <li><strong>Fault tolerance:</strong> Checkpoint/resume capability for long-running jobs</li>
            <li><strong>Late-arrival handling:</strong> Explicit tracking of delayed transactions</li>
            <li><strong>Reconciliation:</strong> Mandatory controls before data persistence</li>
        </ul>
    </div>
</body>
</html>
